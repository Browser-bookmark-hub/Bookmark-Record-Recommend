# Bookmark Recommend Pools v6.2

本文档定义书签推荐系统在 `v6.2` 下的“池子模型（Pool Model）”与流转规则，用于统一侧边栏与页面端行为。

## 1. 版本与目标

- 算法版本：`6.2`
- 目标：
  - 统一推荐卡片在不同实例（侧边栏 / HTML 页面）之间的状态语义。
  - 明确“普通推荐、待复习插队、跳过、屏蔽、已翻牌”等池子关系。
  - 在大批量书签变更时，保证性能与可恢复性。

---

## 2. 核心池子总览

### 2.1 `S 分值缓存池`（Score Cache Pool）

- 存储键：`recommend_scores_cache`
- 作用：保存每个书签的 S 值（及因子），作为推荐排序基础。
- 特点：
  - 支持模板写入 + 细化（refine）。
  - 大量更新时优先模板占位，后续增量补算。

### 2.2 `候选池`（Candidate Pool）

- 含义：从全部 URL 书签中筛出的可推荐集合。
- 过滤条件（v6.2）：
  - 排除被屏蔽书签（bookmarks）。
  - 排除被屏蔽文件夹（folders，含祖先目录）。
  - 排除被屏蔽域名（domains）。
- 输出：用于后续拆分为“到期待复习池 + 普通池”。

### 2.3 `到期待复习池`（Force-Due Queue）

- 来源：`recommend_postponed` 中 `postponeUntil <= now` 且非手动优先项。
- 语义：
  - 强制插队，优先占用推荐卡位。
  - 不受“已翻牌/已跳过”过滤影响。
- 排序：
  1. 未移动队尾的在前；
  2. 已移动队尾按 `dueQueueMovedAt` 升序；
  3. 再按到期时间与 S 值兜底。

### 2.4 `普通池`（Normal Priority Pool）

- 来源：候选池中非 `forceDue` 的项目。
- 排序主轴：`S` 值高优先。
- 跳过语义：
  - 跳过不会删除，只是排到普通池后段。
  - 使用 `recommend_skipped_bookmarks_v1` 的顺序做稳定后移。

### 2.5 `跳过池`（Skipped State Pool）

- 存储键：`recommend_skipped_bookmarks_v1`
- 语义：
  - 记录“普通池后移”的书签 ID 序。
  - 非永久禁用；可在后续轮换中再次出现。

### 2.6 `待复习计划池`（Postponed Plan Pool）

- 存储键：`recommend_postponed`
- 内容：书签的复习计划、到期时间、手动优先标记与队列移动标记。
- 关键字段：
  - `postponeUntil`：到期时间。
  - `manuallyAdded`：手动加入待复习（优先策略）。
  - `dueQueueMovedAt`：到期待复习中被“跳过后移”的顺序标记。

### 2.7 `屏蔽池`（Blocked Pool）

- 存储键：`recommend_blocked`
- 结构：`bookmarks` / `folders` / `domains`。
- 作用：从候选阶段直接剔除。

### 2.8 `当前卡片快照池`（Current Cards Snapshot Pool）

- 存储键：`historyCurrentCards`
- 作用：保存当前三卡位（及翻牌状态）供侧边栏与页面快速复用。

### 2.9 `侧边栏本地快照池`（Sidepanel Local Snapshot Pool）

- 存储键：`bb_sidepanel_recommend_cards_snapshot_v1`（`localStorage`）
- 作用：侧边栏秒开时先渲染快照，减少白屏与抖动。

### 2.10 `普通池游标`（Normal Pool Cursor）

- 存储键：`bb_recommend_pool_cursor_v1`
- 作用：控制普通池轮换批次位置，保证“看完一批再到下一批”。

### 2.11 `已翻牌池`（Flipped Pool）

- 存储键：`flippedBookmarks`
- 作用：记录当前轮已翻牌项目，控制批次推进与防重复。

### 2.12 `复习状态池`（Review State Pool）

- 存储键：`recommend_reviews`
- 作用：维护 SM-2 简化复习状态与下次复习时间，影响 R 因子。

---

## 3. 三卡位出牌规则（v6.2）

每轮固定卡位数：`3`。

1. 先从“到期待复习池”取，最多占满 3 个卡位。
2. 若不足 3 个，剩余卡位由“普通池”按游标补齐。
3. 普通池游标在每次换批后推进。
4. 当当前批次全部翻牌或触发强制刷新，切到下一批。

---

## 4. 操作语义（卡片三操作）

### 4.1 屏蔽（Block）

- 进入屏蔽池并从候选池剔除。
- 影响后续所有推荐计算。

### 4.2 跳过（Skip）

- 普通卡片：写入跳过池，排到普通池后段。
- 到期待复习卡片：不移出插队池，只更新 `dueQueueMovedAt`，移到到期待复习队尾。

### 4.3 待复习（Later / Review）

- 写入待复习计划池。
- 到期后强制插队显示，直到用户复习或再次调整。

---

## 5. 多实例一致性（侧边栏 + HTML 页面）

v6.2 要求：

- `blocked`、`postponed`、`skipped` 等状态通过后台统一通道写入，避免并发覆盖。
- 任一实例改动后，其他实例通过 storage change 同步刷新。
- 侧边栏关闭不影响写入持久化。

---

## 6. 批量变更与性能策略

### 6.2 场景

- 大量导入/删除/移动书签（几千到几万）。

### 6.2 策略

- 进入 bulk guard 后暂停重计算抖动。
- 退出 bulk 时使用模板恢复：
  - 大集合先模板赋值；
  - 再分批细化计算。
- 避免“批量结束立刻全量重算”导致卡顿。

---

## 7. 约束与不变量

- 三卡位总数固定为 3。
- 到期待复习优先级高于普通池。
- 跳过不是禁用，不应变成永久不推荐。
- 屏蔽才是候选剔除语义。
- 跨实例写入必须走后台统一更新。

---

## 8. v6.2 相比 v6.1 的补充点

- 新增“打开成功二次确认”链路：追踪会话超时后用浏览器历史做轻量确认，减少误判漏记。
- 修复链接处理冲突：全局兜底监听支持显式跳过，避免局部逻辑与兜底逻辑双开页面。
- 降低推荐卡片抖动：`recommend_scores_cache` 变更优先走状态同步刷新，不强制换批。
- 优化模板过渡体验：提高模板阈值并缩短 refine 延迟，模板分数在前端排序中降权。
- 优化热力图详情性能：增加短 TTL 书签映射缓存，减少重复全量遍历。

